<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IoT Cyber-Hygiene Assistant</title>
  <meta name="description" content="IoT Cyber-Hygiene Assistant: Risk Scoring + Recommendations Dashboard (Frontend Prototype)">

  <style>
    :root{
      --bg0:#05060a;
      --bg1:#070a12;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.12);
      --stroke2: rgba(255,255,255,.18);
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --muted2: rgba(255,255,255,.42);

      --a:#5ee7ff;
      --b:#7c5cff;
      --c:#00ff9d;
      --d:#ff4d8d;
      --e:#ffb020;

      --shadow: 0 18px 55px rgba(0,0,0,.55);
      --shadow2: 0 10px 25px rgba(0,0,0,.35);
      --r: 22px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    *{ box-sizing: border-box; }
    html,body{ height: 100%; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--txt);
      background: radial-gradient(1200px 700px at 15% 15%, rgba(124,92,255,.22), transparent 60%),
                  radial-gradient(1000px 600px at 85% 20%, rgba(94,231,255,.18), transparent 60%),
                  radial-gradient(900px 600px at 50% 95%, rgba(0,255,157,.10), transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x: hidden;
    }

    /* animated grid */
    .grid-bg{
      position: fixed; inset:0;
      pointer-events:none;
      opacity:.32;
      background:
        linear-gradient(rgba(255,255,255,.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.05) 1px, transparent 1px);
      background-size: 56px 56px;
      mask-image: radial-gradient(800px 400px at 50% 20%, rgba(0,0,0,1), rgba(0,0,0,.2) 55%, transparent 85%);
      animation: gridShift 14s linear infinite;
    }
    @keyframes gridShift{
      0%{ transform: translateY(0); }
      100%{ transform: translateY(56px); }
    }

    /* top glow */
    .glow{
      position: fixed; inset:-200px -200px auto -200px;
      height: 420px;
      background: radial-gradient(circle at 50% 50%,
        rgba(94,231,255,.22),
        rgba(124,92,255,.18),
        transparent 70%);
      filter: blur(18px);
      pointer-events:none;
      opacity:.85;
      animation: breathe 6s ease-in-out infinite;
    }
    @keyframes breathe{
      0%,100%{ transform: translateY(0) scale(1); }
      50%{ transform: translateY(12px) scale(1.02); }
    }

    /* layout */
    .app{
      display: grid;
      grid-template-columns: 290px 1fr;
      gap: 18px;
      max-width: 1440px;
      margin: 0 auto;
      padding: 18px;
      position: relative;
      z-index: 2;
    }

    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
    }

    /* sidebar */
    .sidebar{
      position: sticky;
      top: 18px;
      height: calc(100vh - 36px);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow: hidden;
      display:flex;
      flex-direction: column;
    }

    @media (max-width: 980px){
      .sidebar{
        position: relative;
        height: auto;
      }
    }

    .brand{
      padding: 18px 18px 12px 18px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      gap: 12px;
      align-items:center;
    }
    .logo{
      width: 44px; height: 44px;
      border-radius: 14px;
      background:
        radial-gradient(circle at 30% 30%, rgba(94,231,255,.85), rgba(124,92,255,.35) 60%, rgba(0,0,0,.2) 100%),
        linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 12px 25px rgba(0,0,0,.35);
      position: relative;
      overflow:hidden;
    }
    .logo::after{
      content:"";
      position:absolute; inset:-40%;
      background: conic-gradient(from 180deg, rgba(94,231,255,.0), rgba(94,231,255,.5), rgba(124,92,255,.35), rgba(94,231,255,.0));
      animation: spin 3.2s linear infinite;
      opacity:.9;
    }
    @keyframes spin{ to{ transform: rotate(360deg);} }

    .brand h1{
      margin:0;
      font-size: 15px;
      letter-spacing:.2px;
      line-height: 1.1;
    }
    .brand p{
      margin:4px 0 0 0;
      color: var(--muted);
      font-size: 12px;
      font-family: var(--mono);
    }

    .nav{
      padding: 10px;
      display:flex;
      flex-direction: column;
      gap: 8px;
    }

    .nav button{
      all: unset;
      cursor: pointer;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid transparent;
      display:flex;
      align-items:center;
      gap: 10px;
      transition: .18s ease;
      color: rgba(255,255,255,.88);
    }
    .nav button:hover{
      background: rgba(255,255,255,.05);
      border-color: rgba(255,255,255,.08);
      transform: translateY(-1px);
    }
    .nav button.active{
      background: linear-gradient(135deg, rgba(94,231,255,.12), rgba(124,92,255,.10));
      border-color: rgba(94,231,255,.22);
      box-shadow: 0 12px 28px rgba(0,0,0,.35);
    }
    .ico{
      width: 34px; height: 34px;
      border-radius: 12px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      display:grid;
      place-items:center;
      flex: 0 0 auto;
    }
    .ico svg{ width: 18px; height: 18px; opacity:.95; }

    .nav .label{
      display:flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }
    .nav .label span{
      font-size: 13px;
      font-weight: 650;
    }
    .nav .label small{
      font-size: 11px;
      color: var(--muted);
    }

    .side-footer{
      margin-top:auto;
      padding: 14px 14px 16px 14px;
      border-top: 1px solid rgba(255,255,255,.08);
      display:flex;
      flex-direction: column;
      gap: 10px;
    }

    .chip{
      display:flex;
      align-items:center;
      justify-content: space-between;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      gap: 10px;
      min-width: 0;
    }
    .chip .k{
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
    }
    .chip .v{
      font-family: var(--mono);
      font-size: 12px;
      opacity:.95;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* main */
    .main{
      display:flex;
      flex-direction: column;
      gap: 16px;
      min-width: 0;
    }

    .topbar{
      display:flex;
      gap: 12px;
      align-items: stretch;
      flex-wrap: wrap;
    }

    .search{
      flex: 1 1 340px;
      min-width: min(420px, 100%);
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      padding: 12px 14px;
      display:flex;
      gap: 10px;
      align-items:center;
      box-shadow: var(--shadow2);
    }
    .search input{
      width: 100%;
      border: none;
      outline: none;
      background: transparent;
      color: var(--txt);
      font-size: 13px;
      font-family: var(--mono);
      min-width: 0;
    }
    .search .hint{
      font-size: 11px;
      color: var(--muted2);
      white-space: nowrap;
    }

    .actions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.9);
      border-radius: 18px;
      padding: 12px 14px;
      cursor: pointer;
      transition: .18s ease;
      display:flex;
      align-items:center;
      gap: 10px;
      box-shadow: var(--shadow2);
      font-weight: 650;
      font-size: 13px;
      user-select: none;
      white-space: nowrap;
    }
    .btn:hover{
      transform: translateY(-1px);
      border-color: rgba(94,231,255,.22);
      background: rgba(255,255,255,.07);
    }
    .btn.primary{
      background: linear-gradient(135deg, rgba(94,231,255,.16), rgba(124,92,255,.14));
      border-color: rgba(94,231,255,.22);
    }
    .btn.danger{
      background: linear-gradient(135deg, rgba(255,77,141,.14), rgba(255,176,32,.08));
      border-color: rgba(255,77,141,.22);
    }

    /* cards */
    .grid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap: 16px;
      min-width: 0;
    }
    @media (max-width: 1100px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-width: 0;
    }
    .card .head{
      padding: 16px 16px 12px 16px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      justify-content: space-between;
      align-items:flex-start;
      gap: 12px;
      flex-wrap: wrap;
    }
    .card .head h2{
      margin:0;
      font-size: 14px;
      letter-spacing:.2px;
    }
    .card .head p{
      margin:6px 0 0 0;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
      max-width: 70ch;
    }
    .card .body{
      padding: 16px;
      min-width: 0;
    }

    /* KPI */
    .kpis{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
    @media (max-width: 1100px){
      .kpis{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 520px){
      .kpis{ grid-template-columns: 1fr; }
    }

    .kpi{
      padding: 14px;
      border-radius: 20px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
      display:flex;
      flex-direction: column;
      gap: 8px;
      min-width: 0;
    }
    .kpi .t{
      color: var(--muted);
      font-size: 12px;
    }
    .kpi .v{
      font-size: 22px;
      font-weight: 800;
      letter-spacing: .2px;
      display:flex;
      gap: 10px;
      align-items: baseline;
      min-width: 0;
    }
    .kpi .v small{
      font-size: 12px;
      color: var(--muted);
      font-weight: 600;
      font-family: var(--mono);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.88);
      white-space: nowrap;
    }
    .dot{
      width: 8px; height: 8px; border-radius: 50%;
      background: rgba(94,231,255,.85);
      box-shadow: 0 0 0 4px rgba(94,231,255,.12);
    }

    /* device table */
    .table-wrap{
      overflow:auto;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      max-width: 100%;
    }
    table{
      width: 100%;
      border-collapse: collapse;
      min-width: 820px;
      font-family: var(--mono);
      font-size: 12px;
    }
    @media (max-width: 520px){
      table{ min-width: 760px; }
    }
    th, td{
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      vertical-align: middle;
      white-space: nowrap;
    }
    th{
      text-align:left;
      color: rgba(255,255,255,.70);
      font-weight: 700;
      letter-spacing:.2px;
      background: rgba(255,255,255,.03);
      position: sticky;
      top: 0;
      z-index: 2;
    }
    tr:hover td{
      background: rgba(255,255,255,.03);
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      font-weight: 800;
      letter-spacing: .4px;
    }
    .b-safe{ border-color: rgba(0,255,157,.20); }
    .b-mod{ border-color: rgba(255,176,32,.22); }
    .b-high{ border-color: rgba(255,77,141,.25); }

    .mini{
      font-size: 11px;
      color: var(--muted);
    }

    .row-actions{
      display:flex;
      gap: 8px;
      justify-content:flex-end;
      flex-wrap: wrap;
    }
    .icon-btn{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.86);
      border-radius: 14px;
      padding: 8px 10px;
      cursor:pointer;
      transition: .18s ease;
      font-family: var(--mono);
      font-size: 12px;
    }
    .icon-btn:hover{
      transform: translateY(-1px);
      border-color: rgba(94,231,255,.22);
      background: rgba(255,255,255,.06);
    }

    /* right panel widgets */
    .stack{
      display:flex;
      flex-direction: column;
      gap: 16px;
      min-width: 0;
    }

    .chart{
      width: 100%;
      height: 220px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      overflow:hidden;
      position: relative;
    }
    .chart canvas{
      width: 100%;
      height: 100%;
      display:block;
    }
    .chart .legend{
      position:absolute;
      left: 12px;
      bottom: 12px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* modal */
    .modal-backdrop{
      position: fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .modal{
      width: min(840px, 100%);
      border-radius: 24px;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow: 0 30px 90px rgba(0,0,0,.7);
      overflow:hidden;
    }
    .modal .mhead{
      padding: 16px;
      display:flex;
      justify-content: space-between;
      align-items:flex-start;
      gap: 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .modal .mhead h3{
      margin:0;
      font-size: 14px;
    }
    .modal .mhead p{
      margin:6px 0 0 0;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }
    .modal .mbody{
      padding: 16px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 720px){
      .modal .mbody{ grid-template-columns: 1fr; }
    }
    .field{
      display:flex;
      flex-direction: column;
      gap: 6px;
    }
    .field label{
      font-size: 12px;
      color: var(--muted);
      font-family: var(--mono);
    }
    .field input, .field select, .field textarea{
      width: 100%;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      color: var(--txt);
      outline:none;
      font-size: 13px;
      font-family: var(--mono);
    }
    .field textarea{
      min-height: 96px;
      resize: vertical;
    }

    .modal .mfoot{
      padding: 14px 16px 16px 16px;
      border-top: 1px solid rgba(255,255,255,.08);
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* scan progress */
    .progress{
      width: 100%;
      height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      overflow:hidden;
    }
    .bar{
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(94,231,255,.8), rgba(124,92,255,.75), rgba(0,255,157,.6));
      transition: width .25s ease;
    }

    /* toast */
    .toasts{
      position: fixed;
      right: 18px;
      bottom: 18px;
      display:flex;
      flex-direction: column;
      gap: 10px;
      z-index: 80;
    }
    .toast{
      width: min(360px, calc(100vw - 36px));
      padding: 12px 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      display:flex;
      gap: 10px;
      align-items:flex-start;
      animation: pop .18s ease-out;
    }
    @keyframes pop{
      from{ transform: translateY(10px); opacity:0; }
      to{ transform: translateY(0); opacity:1; }
    }
    .toast .ticon{
      width: 36px; height: 36px;
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      display:grid;
      place-items:center;
      flex: 0 0 auto;
    }
    .toast .tcontent{
      flex:1;
      min-width: 0;
    }
    .toast .tcontent b{
      display:block;
      font-size: 13px;
      margin-bottom: 2px;
    }
    .toast .tcontent span{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
      display:block;
    }
    .toast .x{
      border:none;
      background: transparent;
      color: rgba(255,255,255,.7);
      cursor:pointer;
      font-size: 16px;
      padding: 4px 8px;
    }

    /* details modal extras */
    .tabs{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      padding: 14px 16px 0 16px;
    }
    .tab{
      cursor:pointer;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.86);
      border-radius: 999px;
      padding: 8px 12px;
      font-family: var(--mono);
      font-size: 12px;
      transition: .18s ease;
      user-select:none;
    }
    .tab:hover{ transform: translateY(-1px); border-color: rgba(94,231,255,.22); }
    .tab.active{
      background: linear-gradient(135deg, rgba(94,231,255,.14), rgba(124,92,255,.12));
      border-color: rgba(94,231,255,.22);
    }

    .details-grid{
      padding: 14px 16px 16px 16px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 820px){
      .details-grid{ grid-template-columns: 1fr; }
    }

    .box{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding: 12px;
      min-width: 0;
    }

    .kv{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap: 8px 12px;
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.45;
    }
    @media (max-width: 520px){
      .kv{ grid-template-columns: 1fr; }
    }
    .kv .k{ color: var(--muted); }
    .kv .v{ overflow:hidden; text-overflow: ellipsis; }

    .vuln{
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      margin-bottom: 10px;
    }

    .vuln .top{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }

    .mutebtn{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.86);
      border-radius: 14px;
      padding: 8px 10px;
      cursor:pointer;
      transition: .18s ease;
      font-family: var(--mono);
      font-size: 12px;
    }
    .mutebtn:hover{
      transform: translateY(-1px);
      border-color: rgba(0,255,157,.22);
    }

    /* print report */
    @media print{
      body{ background:#fff; color:#000; }
      .sidebar,.topbar,.toasts,.grid-bg,.glow{ display:none !important; }
      .card{ box-shadow:none; border:1px solid #ddd; }
      .app{ grid-template-columns: 1fr; padding: 0; }
      table{ min-width: 0; }
      .pill,.badge{ border:1px solid #ddd !important; }
    }
  </style>
</head>

<body>
  <div class="glow"></div>
  <div class="grid-bg"></div>

  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>IoT Cyber-Hygiene Assistant</h1>
          <p>Risk Scoring • Recommendations</p>
        </div>
      </div>

      <div class="nav" id="nav">
        <button class="active" data-view="dashboard">
          <div class="ico">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 13h8V3H3v10zM13 21h8V11h-8v10zM13 3h8v6h-8V3zM3 21h8v-6H3v6z"/>
            </svg>
          </div>
          <div class="label">
            <span>Dashboard</span>
            <small>Overview & KPIs</small>
          </div>
        </button>

        <button data-view="devices">
          <div class="ico">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M7 2h10v4H7V2z"/>
              <path d="M5 6h14v16H5V6z"/>
              <path d="M9 10h6M9 14h6M9 18h6"/>
            </svg>
          </div>
          <div class="label">
            <span>Devices</span>
            <small>Scan & manage</small>
          </div>
        </button>

        <button data-view="insights">
          <div class="ico">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 3v18h18"/>
              <path d="M7 14l3-3 3 3 5-7"/>
            </svg>
          </div>
          <div class="label">
            <span>Insights</span>
            <small>Charts & trends</small>
          </div>
        </button>

        <button data-view="recommendations">
          <div class="ico">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2a7 7 0 0 0-4 12v3h8v-3a7 7 0 0 0-4-12z"/>
              <path d="M9 21h6"/>
            </svg>
          </div>
          <div class="label">
            <span>Recommendations</span>
            <small>Fixes & hygiene</small>
          </div>
        </button>

        <button data-view="reports">
          <div class="ico">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"/>
              <path d="M14 2v6h6"/>
              <path d="M8 13h8M8 17h8M8 9h4"/>
            </svg>
          </div>
          <div class="label">
            <span>Reports</span>
            <small>Export & print</small>
          </div>
        </button>
      </div>

      <div class="side-footer">
        <div class="chip">
          <div class="k">Network</div>
          <div class="v" id="netName">Home-Lab</div>
        </div>
        <div class="chip">
          <div class="k">Mode</div>
          <div class="v">Research-Prototype</div>
        </div>
        <div class="chip">
          <div class="k">Storage</div>
          <div class="v">Local (Browser)</div>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <div class="topbar">
        <div class="search">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="7"></circle>
            <path d="M21 21l-4.3-4.3"></path>
          </svg>
          <input id="searchInput" placeholder="Search devices… (name, IP, type, risk)" />
          <div class="hint">Ctrl / ⌘ + K</div>
        </div>

        <div class="actions">
          <button class="btn primary" id="btnDiscover">
            <span>Discover</span>
            <span class="mini">Auto-add</span>
          </button>
          <button class="btn" id="btnAdd">
            <span>Add Device</span>
            <span class="mini">Manual</span>
          </button>
          <button class="btn danger" id="btnScanAll">
            <span>Scan All</span>
            <span class="mini">Risk score</span>
          </button>
        </div>
      </div>

      <!-- Views -->
      <section id="view-dashboard" class="view">
        <div class="card">
          <div class="head">
            <div>
              <h2>Security Overview</h2>
              <p>Real-time cyber-hygiene snapshot. Lightweight risk scoring engine + actionable recommendations. (Frontend prototype)</p>
            </div>
            <div class="pill"><span class="dot"></span> Live Prototype</div>
          </div>
          <div class="body">
            <div class="kpis">
              <div class="kpi">
                <div class="t">Devices Monitored</div>
                <div class="v"><span id="kpiDevices">0</span><small>active</small></div>
              </div>
              <div class="kpi">
                <div class="t">Avg Hygiene Score</div>
                <div class="v"><span id="kpiAvg">—</span><small>/100</small></div>
              </div>
              <div class="kpi">
                <div class="t">High Risk Devices</div>
                <div class="v"><span id="kpiHigh">0</span><small>flagged</small></div>
              </div>
              <div class="kpi">
                <div class="t">Open Port Alerts</div>
                <div class="v"><span id="kpiPorts">0</span><small>issues</small></div>
              </div>
            </div>
          </div>
        </div>

        <div class="grid">
          <div class="card">
            <div class="head">
              <div>
                <h2>Device Inventory</h2>
                <p>Manage devices, run scans, and view per-device cyber-hygiene scoring with vulnerability explanations.</p>
              </div>
              <div class="pill">Filter: <span id="filterLabel">All</span></div>
            </div>
            <div class="body">
              <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px;">
                <button class="btn" data-filter="all">All</button>
                <button class="btn" data-filter="safe">Safe</button>
                <button class="btn" data-filter="moderate">Moderate</button>
                <button class="btn" data-filter="high">High Risk</button>
              </div>

              <div class="table-wrap">
                <table>
                  <thead>
                    <tr>
                      <th>Device</th>
                      <th>Type</th>
                      <th>IP</th>
                      <th>Protocols</th>
                      <th>Score</th>
                      <th>Status</th>
                      <th style="text-align:right;">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="deviceRows"></tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="stack">
            <div class="card">
              <div class="head">
                <div>
                  <h2>Risk Distribution</h2>
                  <p>How your devices are distributed across Safe, Moderate, and High Risk.</p>
                </div>
              </div>
              <div class="body">
                <div class="chart">
                  <canvas id="donut"></canvas>
                  <div class="legend" id="donutLegend"></div>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="head">
                <div>
                  <h2>Quick Recommendations</h2>
                  <p>Top hygiene fixes generated from the current device vulnerabilities.</p>
                </div>
              </div>
              <div class="body" id="quickRecs"></div>
            </div>
          </div>
        </div>
      </section>

      <section id="view-devices" class="view" style="display:none;">
        <div class="card">
          <div class="head">
            <div>
              <h2>Devices</h2>
              <p>Discover, add, scan, edit, and maintain device cyber-hygiene.</p>
            </div>
            <div class="pill">Tip: Scan 1 device for demo</div>
          </div>
          <div class="body">
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Device</th>
                    <th>Type</th>
                    <th>IP</th>
                    <th>Ports</th>
                    <th>Weak Auth</th>
                    <th>Firmware</th>
                    <th>Score</th>
                    <th style="text-align:right;">Actions</th>
                  </tr>
                </thead>
                <tbody id="deviceRows2"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <section id="view-insights" class="view" style="display:none;">
        <div class="grid">
          <div class="card">
            <div class="head">
              <div>
                <h2>Score Trend (Simulation)</h2>
                <p>In a real backend, this would show scan history. Here it’s simulated for UI analytics.</p>
              </div>
            </div>
            <div class="body">
              <div class="chart" style="height:260px;">
                <canvas id="line"></canvas>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="head">
              <div>
                <h2>Vulnerability Types</h2>
                <p>Distribution of common IoT issues detected by the scoring engine.</p>
              </div>
            </div>
            <div class="body">
              <div class="chart" style="height:260px;">
                <canvas id="bars"></canvas>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="view-recommendations" class="view" style="display:none;">
        <div class="card">
          <div class="head">
            <div>
              <h2>Recommendations Engine</h2>
              <p>Fix suggestions are generated from each device’s risk profile. This is the core “cyber-hygiene assistant”.</p>
            </div>
            <div class="pill">Actionable</div>
          </div>
          <div class="body" id="allRecs"></div>
        </div>
      </section>

      <section id="view-reports" class="view" style="display:none;">
        <div class="card">
          <div class="head">
            <div>
              <h2>Reports</h2>
              <p>Export your current scan state as JSON/CSV or print a clean report for your PBL submission.</p>
            </div>
          </div>
          <div class="body">
            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px;">
              <button class="btn primary" id="btnExportJSON">Export JSON</button>
              <button class="btn" id="btnExportCSV">Export CSV</button>
              <button class="btn" id="btnExportHTML">Export HTML Report</button>
              <button class="btn" id="btnPrint">Print Report</button>
              <button class="btn danger" id="btnReset">Reset Demo Data</button>
            </div>

            <div class="card" style="box-shadow:none;">
              <div class="head">
                <div>
                  <h2>Printable Summary</h2>
                  <p>Auto-generated summary from your device data.</p>
                </div>
              </div>
              <div class="body" id="printable"></div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Modal: Add Device -->
  <div class="modal-backdrop" id="modalAdd">
    <div class="modal">
      <div class="mhead">
        <div>
          <h3 id="addTitle">Add IoT Device</h3>
          <p id="addSubtitle">Manually add a device. Risk scoring will apply on scan.</p>
        </div>
        <button class="x" onclick="closeModal('modalAdd')">✕</button>
      </div>

      <div class="mbody">
        <div class="field">
          <label>Device Name</label>
          <input id="fName" placeholder="e.g., TP-Link Camera" />
        </div>
        <div class="field">
          <label>Type</label>
          <select id="fType">
            <option>Camera</option>
            <option>Router</option>
            <option>Smart Bulb</option>
            <option>Speaker</option>
            <option>Sensor</option>
            <option>Wearable</option>
            <option>Smart Lock</option>
            <option>Other</option>
          </select>
        </div>
        <div class="field">
          <label>IP Address</label>
          <input id="fIP" placeholder="192.168.1.25" />
        </div>
        <div class="field">
          <label>Protocols</label>
          <select id="fProto">
            <option>HTTP, MQTT</option>
            <option>HTTPS, MQTT</option>
            <option>HTTPS</option>
            <option>HTTP</option>
            <option>MQTT</option>
            <option>CoAP</option>
            <option>RTSP</option>
          </select>
        </div>

        <div class="field">
          <label>Ports (comma separated)</label>
          <input id="fPorts" placeholder="80, 1883, 554" />
        </div>
        <div class="field">
          <label>Firmware State</label>
          <select id="fFirmware">
            <option>Up-to-date</option>
            <option>Outdated</option>
            <option>Unknown</option>
          </select>
        </div>

        <div class="field">
          <label>Weak Authentication</label>
          <select id="fWeak">
            <option value="auto">Auto (Demo)</option>
            <option value="true">Yes</option>
            <option value="false">No</option>
          </select>
        </div>

        <div class="field">
          <label>Notes</label>
          <textarea id="fNotes" placeholder="Optional: demo notes"></textarea>
        </div>
      </div>

      <div class="mfoot">
        <button class="btn" onclick="closeModal('modalAdd')">Cancel</button>
        <button class="btn primary" id="btnSaveDevice">Save Device</button>
      </div>
    </div>
  </div>

  <!-- Modal: Scan -->
  <div class="modal-backdrop" id="modalScan">
    <div class="modal">
      <div class="mhead">
        <div>
          <h3>Scanning…</h3>
          <p id="scanText">Initializing scan engine…</p>
        </div>
        <button class="x" onclick="closeModal('modalScan')">✕</button>
      </div>

      <div class="mbody" style="grid-template-columns: 1fr;">
        <div class="progress"><div class="bar" id="scanBar"></div></div>
        <div class="mini" id="scanLog" style="line-height:1.6;"></div>
      </div>

      <div class="mfoot">
        <button class="btn" onclick="closeModal('modalScan')">Close</button>
      </div>
    </div>
  </div>

  <!-- Modal: Device Details -->
  <div class="modal-backdrop" id="modalDetails">
    <div class="modal">
      <div class="mhead">
        <div>
          <h3 id="detailsTitle">Device Details</h3>
          <p id="detailsSub">Risk profile, vulnerabilities, and scan history.</p>
        </div>
        <button class="x" onclick="closeModal('modalDetails')">✕</button>
      </div>

      <div class="tabs" id="detailsTabs">
        <div class="tab active" data-tab="overview">Overview</div>
        <div class="tab" data-tab="vulns">Vulnerabilities</div>
        <div class="tab" data-tab="history">Scan History</div>
      </div>

      <div id="detailsContent"></div>

      <div class="mfoot">
        <button class="btn" onclick="closeModal('modalDetails')">Close</button>
      </div>
    </div>
  </div>

  <div class="toasts" id="toasts"></div>

  <script>
    /**********************
     * FINAL BOSS DATA MODEL
     **********************/
    const LS_KEY = "iot_hygiene_devices_v2_finalboss";

    const defaultDevices = [
      {
        id: crypto.randomUUID(),
        name: "Home Router",
        type: "Router",
        ip: "192.168.1.1",
        protocols: ["HTTPS"],
        ports: [443, 53],
        weakAuth: false,
        firmware: "Up-to-date",
        lastScan: null,
        notes: "Gateway device. Keep admin panel secured.",
        history: []
      },
      {
        id: crypto.randomUUID(),
        name: "IP Camera (Living Room)",
        type: "Camera",
        ip: "192.168.1.24",
        protocols: ["HTTP","RTSP"],
        ports: [80, 554],
        weakAuth: true,
        firmware: "Outdated",
        lastScan: null,
        notes: "Common target. RTSP exposed.",
        history: []
      },
      {
        id: crypto.randomUUID(),
        name: "Smart Bulb",
        type: "Smart Bulb",
        ip: "192.168.1.31",
        protocols: ["MQTT"],
        ports: [1883],
        weakAuth: false,
        firmware: "Unknown",
        lastScan: null,
        notes: "MQTT should be secured.",
        history: []
      },
      {
        id: crypto.randomUUID(),
        name: "Smart Speaker",
        type: "Speaker",
        ip: "192.168.1.18",
        protocols: ["HTTPS"],
        ports: [443],
        weakAuth: false,
        firmware: "Up-to-date",
        lastScan: null,
        notes: "Voice devices = privacy sensitive.",
        history: []
      }
    ];

    let devices = loadDevices();
    let activeFilter = "all";
    let searchQuery = "";
    let editingId = null;
    let detailsId = null;
    let detailsTab = "overview";

    function loadDevices(){
      const raw = localStorage.getItem(LS_KEY);
      if(!raw){
        localStorage.setItem(LS_KEY, JSON.stringify(defaultDevices));
        return structuredClone(defaultDevices);
      }
      try{
        const parsed = JSON.parse(raw);
        if(!Array.isArray(parsed)) throw new Error("bad");
        // Backfill missing fields
        return parsed.map(d=>({
          history: [],
          ...d,
          history: Array.isArray(d.history) ? d.history : []
        }));
      }catch{
        localStorage.setItem(LS_KEY, JSON.stringify(defaultDevices));
        return structuredClone(defaultDevices);
      }
    }
    function saveDevices(){
      localStorage.setItem(LS_KEY, JSON.stringify(devices));
    }

    /**********************
     * RISK SCORING ENGINE
     **********************/
    function scoreDevice(d){
      let score = 100;
      const vulns = [];

      if(d.weakAuth){
        score -= 28;
        vulns.push({
          id:"weak_auth",
          k:"Weak Authentication",
          s:"High",
          why:"Device may be using default or weak credentials, enabling brute force or takeover.",
          fix:"Change admin password, enable 2FA if available, disable guest/admin exposure."
        });
      }

      if((d.firmware||"").toLowerCase().includes("outdated")){
        score -= 22;
        vulns.push({
          id:"outdated_fw",
          k:"Outdated Firmware",
          s:"High",
          why:"Older firmware contains known vulnerabilities and unpatched exploits.",
          fix:"Update firmware from official vendor, enable auto-update if available."
        });
      } else if((d.firmware||"").toLowerCase().includes("unknown")){
        score -= 10;
        vulns.push({
          id:"unknown_fw",
          k:"Unknown Firmware State",
          s:"Moderate",
          why:"Firmware version is not verified, increasing uncertainty of patch level.",
          fix:"Check vendor app/web panel for firmware version and apply latest update."
        });
      }

      const p = (d.protocols||[]).map(x=>String(x).toUpperCase());
      if(p.includes("HTTP")){
        score -= 14;
        vulns.push({
          id:"http",
          k:"Unencrypted HTTP",
          s:"Moderate",
          why:"Traffic may be intercepted (MITM), exposing credentials or video feeds.",
          fix:"Switch to HTTPS, disable HTTP in settings, use VPN for remote access."
        });
      }
      if(p.includes("MQTT")){
        score -= 8;
        vulns.push({
          id:"mqtt",
          k:"MQTT Without TLS (Assumed)",
          s:"Moderate",
          why:"MQTT is commonly deployed without TLS, enabling sniffing and message injection.",
          fix:"Use MQTTS (TLS), enforce authentication, restrict broker access."
        });
      }
      if(p.includes("RTSP")){
        score -= 12;
        vulns.push({
          id:"rtsp",
          k:"RTSP Exposure Risk",
          s:"Moderate",
          why:"RTSP streams can be exposed if ports are open or auth is weak.",
          fix:"Disable RTSP if unused, restrict to LAN, use strong credentials."
        });
      }

      const riskyPorts = new Set([21,22,23,25,53,80,81,110,139,143,445,554,1883,1900,2323,3389]);
      const ports = d.ports || [];
      const openRiskCount = ports.filter(x => riskyPorts.has(Number(x))).length;

      if(openRiskCount >= 3){
        score -= 18;
        vulns.push({
          id:"ports_high",
          k:"Multiple Risky Open Ports",
          s:"High",
          why:"Multiple exposed services increase attack surface significantly.",
          fix:"Close unused ports, disable UPnP, isolate IoT VLAN if possible."
        });
      } else if(openRiskCount === 2){
        score -= 12;
        vulns.push({
          id:"ports_mod",
          k:"Risky Open Ports Detected",
          s:"Moderate",
          why:"Some services may be exploitable if exposed externally.",
          fix:"Close unnecessary ports and restrict access to local network only."
        });
      } else if(openRiskCount === 1){
        score -= 7;
        vulns.push({
          id:"ports_low",
          k:"Potentially Risky Port",
          s:"Low",
          why:"A common port associated with IoT attacks is open.",
          fix:"Confirm the port is needed; restrict exposure to LAN."
        });
      }

      score = Math.max(0, Math.min(100, Math.round(score)));

      let status = "Safe";
      if(score < 50) status = "High Risk";
      else if(score < 80) status = "Moderate";

      return { score, status, vulns };
    }

    function computeAll(){
      return devices.map(d=>{
        const res = scoreDevice(d);
        return { ...d, ...res };
      });
    }

    /**********************
     * UI RENDER
     **********************/
    const el = (id)=>document.getElementById(id);

    function badge(status){
      if(status==="Safe") return `<span class="badge b-safe">SAFE</span>`;
      if(status==="Moderate") return `<span class="badge b-mod">MODERATE</span>`;
      return `<span class="badge b-high">HIGH RISK</span>`;
    }

    function filterDevices(list){
      let out = list;

      if(activeFilter !== "all"){
        out = out.filter(d=>{
          if(activeFilter==="safe") return d.status==="Safe";
          if(activeFilter==="moderate") return d.status==="Moderate";
          if(activeFilter==="high") return d.status==="High Risk";
          return true;
        });
      }

      if(searchQuery.trim()){
        const q = searchQuery.toLowerCase();
        out = out.filter(d =>
          (d.name||"").toLowerCase().includes(q) ||
          (d.type||"").toLowerCase().includes(q) ||
          (d.ip||"").toLowerCase().includes(q) ||
          (d.status||"").toLowerCase().includes(q) ||
          (d.protocols||[]).join(",").toLowerCase().includes(q)
        );
      }

      return out;
    }

    function render(){
      const list = computeAll();
      const filtered = filterDevices(list);

      // KPIs
      el("kpiDevices").textContent = list.length;
      const avg = list.length ? Math.round(list.reduce((a,b)=>a+b.score,0)/list.length) : 0;
      el("kpiAvg").textContent = list.length ? avg : "—";
      const high = list.filter(d=>d.status==="High Risk").length;
      el("kpiHigh").textContent = high;

      const openPortsAlerts = list.reduce((sum,d)=>{
        const risky = [21,22,23,25,53,80,81,110,139,143,445,554,1883,1900,2323,3389];
        const c = (d.ports||[]).filter(p=>risky.includes(Number(p))).length;
        return sum + c;
      },0);
      el("kpiPorts").textContent = openPortsAlerts;

      // Tables
      el("deviceRows").innerHTML = filtered.map(d=>`
        <tr>
          <td>
            <div style="display:flex; flex-direction:column; gap:3px;">
              <b style="font-family: var(--sans); font-size: 13px;">${escapeHtml(d.name)}</b>
              <span class="mini">${escapeHtml(d.notes || "—")}</span>
            </div>
          </td>
          <td>${escapeHtml(d.type)}</td>
          <td>${escapeHtml(d.ip)}</td>
          <td>${escapeHtml((d.protocols||[]).join(", "))}</td>
          <td><b style="font-size:14px;">${d.score}</b></td>
          <td>${badge(d.status)}</td>
          <td>
            <div class="row-actions">
              <button class="icon-btn" onclick="scanOne('${d.id}')">Scan</button>
              <button class="icon-btn" onclick="openDetails('${d.id}')">Details</button>
              <button class="icon-btn" onclick="editDevice('${d.id}')">Edit</button>
              <button class="icon-btn" onclick="removeDevice('${d.id}')">Delete</button>
            </div>
          </td>
        </tr>
      `).join("");

      el("deviceRows2").innerHTML = filtered.map(d=>{
        const ports = (d.ports||[]).join(", ");
        const weak = d.weakAuth ? "YES" : "NO";
        return `
          <tr>
            <td><b style="font-family: var(--sans);">${escapeHtml(d.name)}</b></td>
            <td>${escapeHtml(d.type)}</td>
            <td>${escapeHtml(d.ip)}</td>
            <td>${escapeHtml(ports || "—")}</td>
            <td>${weak}</td>
            <td>${escapeHtml(d.firmware || "—")}</td>
            <td><b>${d.score}</b> <span class="mini">(${escapeHtml(d.status)})</span></td>
            <td>
              <div class="row-actions">
                <button class="icon-btn" onclick="scanOne('${d.id}')">Scan</button>
                <button class="icon-btn" onclick="openDetails('${d.id}')">Details</button>
                <button class="icon-btn" onclick="editDevice('${d.id}')">Edit</button>
              </div>
            </td>
          </tr>
        `;
      }).join("");

      // donut
      const safe = list.filter(d=>d.status==="Safe").length;
      const mod = list.filter(d=>d.status==="Moderate").length;
      const hi = list.filter(d=>d.status==="High Risk").length;
      drawDonut("donut", [safe, mod, hi]);

      el("donutLegend").innerHTML = `
        <span class="pill"><span class="dot" style="background: rgba(0,255,157,.9)"></span> Safe: ${safe}</span>
        <span class="pill"><span class="dot" style="background: rgba(255,176,32,.9)"></span> Moderate: ${mod}</span>
        <span class="pill"><span class="dot" style="background: rgba(255,77,141,.9)"></span> High: ${hi}</span>
      `;

      renderRecommendations(list);
      drawLine("line", list);
      drawBars("bars", list);
      renderPrintable(list);

      // if details modal open, refresh it live
      if(el("modalDetails").style.display === "flex" && detailsId){
        renderDetails();
      }
    }

    function renderRecommendations(list){
      const allV = list.flatMap(d => (d.vulns||[]).map(v => ({...v, device:d.name, id:d.id})));

      const grouped = {};
      for(const v of allV){
        grouped[v.k] = grouped[v.k] || {k:v.k, count:0, s:v.s, why:v.why, fix:v.fix};
        grouped[v.k].count++;
      }
      const sorted = Object.values(grouped).sort((a,b)=>b.count-a.count);

      const top = sorted.slice(0,5);
      el("quickRecs").innerHTML = top.length ? top.map(r=>`
        <div style="padding:12px; border-radius:18px; border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.18); margin-bottom:10px;">
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap;">
            <b style="font-size:13px;">${escapeHtml(r.k)}</b>
            <span class="pill">${escapeHtml(r.s)} • ${r.count} devices</span>
          </div>
          <div class="mini" style="margin-top:8px;">${escapeHtml(r.why)}</div>
          <div class="mini" style="margin-top:8px;"><b>Fix:</b> ${escapeHtml(r.fix)}</div>
        </div>
      `).join("") : `<div class="mini">No vulnerabilities detected yet. Run a scan.</div>`;

      const byDevice = list.map(d=>({ d, v: d.vulns || [] }));

      el("allRecs").innerHTML = byDevice.map(({d,v})=>`
        <div style="padding:14px; border-radius:22px; border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.16); margin-bottom:12px;">
          <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:center;">
            <div>
              <b style="font-size:14px;">${escapeHtml(d.name)}</b>
              <div class="mini">${escapeHtml(d.type)} • ${escapeHtml(d.ip)} • ${escapeHtml((d.protocols||[]).join(", "))}</div>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <div class="pill">Score: <b style="margin-left:6px;">${d.score}</b> / 100</div>
              <button class="mutebtn" onclick="openDetails('${d.id}')">Open Details</button>
            </div>
          </div>

          <div style="margin-top:12px;">
            ${v.length ? v.map(x=>`
              <div class="vuln">
                <div class="top">
                  <b>${escapeHtml(x.k)}</b>
                  <span class="pill">${escapeHtml(x.s)}</span>
                </div>
                <div class="mini" style="margin-top:6px;"><b>Why:</b> ${escapeHtml(x.why)}</div>
                <div class="mini" style="margin-top:6px;"><b>Fix:</b> ${escapeHtml(x.fix)}</div>
              </div>
            `).join("") : `<div class="mini">No issues detected. Device is in good hygiene state.</div>`}
          </div>
        </div>
      `).join("");
    }

    function renderPrintable(list){
      const avg = list.length ? Math.round(list.reduce((a,b)=>a+b.score,0)/list.length) : 0;
      const safe = list.filter(d=>d.status==="Safe").length;
      const mod = list.filter(d=>d.status==="Moderate").length;
      const hi = list.filter(d=>d.status==="High Risk").length;

      el("printable").innerHTML = `
        <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;">
          <div>
            <b style="font-size:16px;">IoT Cyber-Hygiene Report</b>
            <div class="mini">Generated locally • ${new Date().toLocaleString()}</div>
          </div>
          <div class="pill">Avg Score: <b style="margin-left:6px;">${avg}</b>/100</div>
        </div>

        <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
          <span class="pill"><span class="dot" style="background: rgba(0,255,157,.9)"></span> Safe: ${safe}</span>
          <span class="pill"><span class="dot" style="background: rgba(255,176,32,.9)"></span> Moderate: ${mod}</span>
          <span class="pill"><span class="dot" style="background: rgba(255,77,141,.9)"></span> High Risk: ${hi}</span>
        </div>

        <div style="margin-top:14px;" class="table-wrap">
          <table style="min-width: 0;">
            <thead>
              <tr>
                <th>Device</th>
                <th>IP</th>
                <th>Type</th>
                <th>Score</th>
                <th>Status</th>
                <th>Last Scan</th>
              </tr>
            </thead>
            <tbody>
              ${list.map(d=>`
                <tr>
                  <td>${escapeHtml(d.name)}</td>
                  <td>${escapeHtml(d.ip)}</td>
                  <td>${escapeHtml(d.type)}</td>
                  <td><b>${d.score}</b></td>
                  <td>${escapeHtml(d.status)}</td>
                  <td>${d.lastScan ? escapeHtml(new Date(d.lastScan).toLocaleString()) : "—"}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>

        <div style="margin-top:14px;" class="mini">
          <b>Note:</b> This is a research-based frontend prototype. In a full implementation, scans would be performed using tools like Nmap/Wireshark and results would be validated via a backend engine.
        </div>
      `;
    }

    /**********************
     * DETAILS MODAL (NO ALERTS)
     **********************/
    function openDetails(id){
      detailsId = id;
      detailsTab = "overview";
      document.querySelectorAll("#detailsTabs .tab").forEach(t=>t.classList.remove("active"));
      document.querySelector(`#detailsTabs .tab[data-tab="overview"]`).classList.add("active");
      openModal("modalDetails");
      renderDetails();
    }

    function renderDetails(){
      const d = computeAll().find(x=>x.id===detailsId);
      if(!d) return;

      el("detailsTitle").textContent = d.name;
      el("detailsSub").textContent = `${d.type} • ${d.ip} • Score ${d.score}/100 (${d.status})`;

      const content = document.createElement("div");

      if(detailsTab === "overview"){
        content.innerHTML = `
          <div class="details-grid">
            <div class="box">
              <b style="display:block; margin-bottom:10px;">Device Profile</b>
              <div class="kv">
                <div class="k">Name</div><div class="v">${escapeHtml(d.name)}</div>
                <div class="k">Type</div><div class="v">${escapeHtml(d.type)}</div>
                <div class="k">IP</div><div class="v">${escapeHtml(d.ip)}</div>
                <div class="k">Protocols</div><div class="v">${escapeHtml((d.protocols||[]).join(", "))}</div>
                <div class="k">Ports</div><div class="v">${escapeHtml((d.ports||[]).join(", ") || "—")}</div>
                <div class="k">Firmware</div><div class="v">${escapeHtml(d.firmware || "—")}</div>
                <div class="k">Weak Auth</div><div class="v">${d.weakAuth ? "YES" : "NO"}</div>
                <div class="k">Last Scan</div><div class="v">${d.lastScan ? escapeHtml(new Date(d.lastScan).toLocaleString()) : "—"}</div>
              </div>
            </div>

            <div class="box">
              <b style="display:block; margin-bottom:10px;">Quick Actions</b>
              <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn primary" onclick="scanOne('${d.id}')">Run Scan</button>
                <button class="btn" onclick="editDevice('${d.id}')">Edit Device</button>
                <button class="btn danger" onclick="removeDevice('${d.id}')">Delete</button>
              </div>

              <div style="margin-top:12px;" class="mini">
                <b>Tip:</b> Use “Fix Applied” inside Vulnerabilities to simulate improving hygiene score.
              </div>
            </div>
          </div>
        `;
      }

      if(detailsTab === "vulns"){
        const v = d.vulns || [];
        content.innerHTML = `
          <div class="details-grid">
            <div class="box" style="grid-column: 1 / -1;">
              <b style="display:block; margin-bottom:10px;">Detected Vulnerabilities</b>
              ${v.length ? v.map(x=>`
                <div class="vuln">
                  <div class="top">
                    <div>
                      <b>${escapeHtml(x.k)}</b>
                      <div class="mini">${escapeHtml(x.s)} severity</div>
                    </div>
                    <button class="mutebtn" onclick="applyFix('${d.id}','${x.id}')">Fix Applied</button>
                  </div>
                  <div class="mini" style="margin-top:8px;"><b>Why:</b> ${escapeHtml(x.why)}</div>
                  <div class="mini" style="margin-top:6px;"><b>Fix:</b> ${escapeHtml(x.fix)}</div>
                </div>
              `).join("") : `<div class="mini">No issues detected. Device is in a safe hygiene state.</div>`}
            </div>
          </div>
        `;
      }

      if(detailsTab === "history"){
        const h = Array.isArray(d.history) ? d.history.slice().reverse() : [];
        content.innerHTML = `
          <div class="details-grid">
            <div class="box" style="grid-column: 1 / -1;">
              <b style="display:block; margin-bottom:10px;">Scan History</b>
              ${h.length ? `
                <div class="table-wrap">
                  <table style="min-width: 0;">
                    <thead>
                      <tr>
                        <th>Timestamp</th>
                        <th>Score</th>
                        <th>Status</th>
                        <th>Issues</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${h.map(x=>`
                        <tr>
                          <td>${escapeHtml(new Date(x.t).toLocaleString())}</td>
                          <td><b>${x.score}</b></td>
                          <td>${escapeHtml(x.status)}</td>
                          <td>${escapeHtml(String(x.issues))}</td>
                        </tr>
                      `).join("")}
                    </tbody>
                  </table>
                </div>
              ` : `<div class="mini">No scan history yet. Run a scan.</div>`}
            </div>
          </div>
        `;
      }

      const holder = el("detailsContent");
      holder.innerHTML = "";
      holder.appendChild(content);
    }

    document.querySelectorAll("#detailsTabs .tab").forEach(t=>{
      t.addEventListener("click", ()=>{
        document.querySelectorAll("#detailsTabs .tab").forEach(x=>x.classList.remove("active"));
        t.classList.add("active");
        detailsTab = t.dataset.tab;
        renderDetails();
      });
    });

    function applyFix(id, vulnId){
      const d = devices.find(x=>x.id===id);
      if(!d) return;

      // Minimal simulation of fixing vulnerabilities
      if(vulnId === "weak_auth") d.weakAuth = false;
      if(vulnId === "outdated_fw" || vulnId === "unknown_fw") d.firmware = "Up-to-date";
      if(vulnId === "http"){
        d.protocols = Array.from(new Set((d.protocols||[]).map(p=>p.toUpperCase() === "HTTP" ? "HTTPS" : p)));
      }
      if(vulnId === "mqtt"){
        // simulate secure mqtt by switching label
        d.protocols = (d.protocols||[]).map(p=>p.toUpperCase()==="MQTT" ? "MQTTS" : p);
      }
      if(vulnId === "rtsp"){
        d.protocols = (d.protocols||[]).filter(p=>String(p).toUpperCase()!=="RTSP");
        d.ports = (d.ports||[]).filter(p=>Number(p)!==554);
      }
      if(vulnId.startsWith("ports")){
        // remove one risky port if possible
        const risky = [21,22,23,25,53,80,81,110,139,143,445,554,1883,1900,2323,3389];
        const current = d.ports || [];
        const idx = current.findIndex(p=>risky.includes(Number(p)));
        if(idx !== -1) current.splice(idx,1);
        d.ports = current;
      }

      saveDevices();
      render();
      toast("Fix applied", "Device hygiene improved (simulated).");
    }

    /**********************
     * CHARTS (PURE CANVAS)
     **********************/
    function setupCanvas(id){
      const c = el(id);
      const rect = c.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      c.width = Math.floor(rect.width * dpr);
      c.height = Math.floor(rect.height * dpr);
      const ctx = c.getContext("2d");
      ctx.setTransform(dpr,0,0,dpr,0,0);
      return {c, ctx, w: rect.width, h: rect.height};
    }

    function drawDonut(id, values){
      const {ctx,w,h} = setupCanvas(id);
      ctx.clearRect(0,0,w,h);

      const total = values.reduce((a,b)=>a+b,0) || 1;
      const cx = w/2, cy = h/2;
      const r = Math.min(w,h)*0.33;
      const thick = Math.max(18, r*0.35);

      const colors = [
        "rgba(0,255,157,.85)",
        "rgba(255,176,32,.85)",
        "rgba(255,77,141,.85)"
      ];

      let start = -Math.PI/2;
      for(let i=0;i<values.length;i++){
        const ang = (values[i]/total) * Math.PI*2;
        ctx.beginPath();
        ctx.strokeStyle = colors[i];
        ctx.lineWidth = thick;
        ctx.lineCap = "round";
        ctx.arc(cx, cy, r, start, start+ang);
        ctx.stroke();
        start += ang;
      }

      ctx.fillStyle = "rgba(255,255,255,.92)";
      ctx.font = "800 22px " + getComputedStyle(document.body).fontFamily;
      const safe = values[0];
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(`${safe}`, cx, cy-8);
      ctx.fillStyle = "rgba(255,255,255,.60)";
      ctx.font = "12px " + getComputedStyle(document.body).fontFamily;
      ctx.fillText("Safe Devices", cx, cy+16);
    }

    function drawLine(id, list){
      const {ctx,w,h} = setupCanvas(id);
      ctx.clearRect(0,0,w,h);

      const avg = list.length ? list.reduce((a,b)=>a+b.score,0)/list.length : 70;
      const points = Array.from({length: 10}, (_,i)=>{
        const jitter = (Math.random()*12 - 6);
        return Math.max(0, Math.min(100, Math.round(avg + jitter + (i-6)*0.7)));
      });

      ctx.strokeStyle = "rgba(255,255,255,.08)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(18, 18);
      ctx.lineTo(18, h-18);
      ctx.lineTo(w-18, h-18);
      ctx.stroke();

      const x0=18, y0=h-18, x1=w-18, y1=18;
      const dx=(x1-x0)/(points.length-1);

      ctx.strokeStyle = "rgba(94,231,255,.85)";
      ctx.lineWidth = 2.5;
      ctx.beginPath();
      points.forEach((v,i)=>{
        const x=x0+i*dx;
        const y=y0 - (v/100)*(y0-y1);
        if(i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      });
      ctx.stroke();

      points.forEach((v,i)=>{
        const x=x0+i*dx;
        const y=y0 - (v/100)*(y0-y1);
        ctx.fillStyle = "rgba(124,92,255,.85)";
        ctx.beginPath();
        ctx.arc(x,y,4,0,Math.PI*2);
        ctx.fill();
      });

      ctx.fillStyle = "rgba(255,255,255,.70)";
      ctx.font = "12px " + getComputedStyle(document.body).fontFamily;
      ctx.fillText("Hygiene Score Trend (simulated)", 22, 22);
    }

    function drawBars(id, list){
      const {ctx,w,h} = setupCanvas(id);
      ctx.clearRect(0,0,w,h);

      const allV = list.flatMap(d => d.vulns || []);
      const counts = {
        "Weak Auth": 0,
        "Outdated Firmware": 0,
        "Unencrypted HTTP": 0,
        "MQTT (no TLS)": 0,
        "Open Ports": 0,
        "RTSP Exposure": 0
      };

      for(const v of allV){
        if(v.k.includes("Weak")) counts["Weak Auth"]++;
        else if(v.k.includes("Outdated")) counts["Outdated Firmware"]++;
        else if(v.k.includes("HTTP")) counts["Unencrypted HTTP"]++;
        else if(v.k.includes("MQTT")) counts["MQTT (no TLS)"]++;
        else if(v.k.includes("Ports")) counts["Open Ports"]++;
        else if(v.k.includes("RTSP")) counts["RTSP Exposure"]++;
      }

      const keys = Object.keys(counts);
      const vals = keys.map(k=>counts[k]);
      const max = Math.max(1, ...vals);

      const pad=18;
      const bw = (w - pad*2) / keys.length;
      const base = h - pad;

      ctx.strokeStyle = "rgba(255,255,255,.08)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(pad, pad);
      ctx.lineTo(pad, base);
      ctx.lineTo(w-pad, base);
      ctx.stroke();

      keys.forEach((k,i)=>{
        const v = vals[i];
        const bh = (v/max) * (h - pad*2 - 24);
        const x = pad + i*bw + bw*0.18;
        const y = base - bh;

        ctx.fillStyle = "rgba(0,255,157,.20)";
        ctx.strokeStyle = "rgba(94,231,255,.25)";
        ctx.lineWidth = 1;
        ctx.beginPath();
        roundRect(ctx, x, y, bw*0.64, bh, 10);
        ctx.fill();
        ctx.stroke();

        ctx.fillStyle = "rgba(255,255,255,.78)";
        ctx.font = "12px " + getComputedStyle(document.body).fontFamily;
        ctx.textAlign = "center";
        ctx.fillText(String(v), x + bw*0.32, y - 8);

        ctx.fillStyle = "rgba(255,255,255,.55)";
        ctx.font = "10px " + getComputedStyle(document.body).fontFamily;
        ctx.fillText(k, x + bw*0.32, base + 12);
      });

      ctx.textAlign = "left";
      ctx.fillStyle = "rgba(255,255,255,.70)";
      ctx.font = "12px " + getComputedStyle(document.body).fontFamily;
      ctx.fillText("Vulnerability Distribution", pad+4, pad+4);
    }

    function roundRect(ctx, x, y, w, h, r){
      const rr = Math.min(r, w/2, h/2);
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
    }

    /**********************
     * ACTIONS
     **********************/
    function toast(title, msg){
      const t = document.createElement("div");
      t.className = "toast";
      t.innerHTML = `
        <div class="ticon">⚡</div>
        <div class="tcontent">
          <b>${escapeHtml(title)}</b>
          <span>${escapeHtml(msg)}</span>
        </div>
        <button class="x">✕</button>
      `;
      t.querySelector(".x").onclick = ()=>t.remove();
      el("toasts").appendChild(t);
      setTimeout(()=>{ if(t.isConnected) t.remove(); }, 4500);
    }

    function openModal(id){ el(id).style.display="flex"; }
    function closeModal(id){ el(id).style.display="none"; }

    function discover(){
      const candidates = [
        {name:"Mi Smart Band", type:"Wearable", ip: randIP(), protocols:["HTTPS"], ports:[443], weakAuth:false, firmware:"Up-to-date", notes:"Wearable sync device", history:[]},
        {name:"Smart Lock", type:"Smart Lock", ip: randIP(), protocols:["HTTPS"], ports:[443], weakAuth:false, firmware:"Unknown", notes:"Critical physical access", history:[]},
        {name:"ESP32 Sensor Node", type:"Sensor", ip: randIP(), protocols:["HTTP","MQTT"], ports:[80,1883], weakAuth:true, firmware:"Unknown", notes:"DIY node (often insecure)", history:[]},
        {name:"TP-Link Bulb", type:"Smart Bulb", ip: randIP(), protocols:["MQTT"], ports:[1883], weakAuth:false, firmware:"Up-to-date", notes:"MQTT should be protected", history:[]},
      ];

      const addCount = Math.floor(Math.random()*2)+2;
      for(let i=0;i<addCount;i++){
        const pick = candidates[Math.floor(Math.random()*candidates.length)];
        devices.push({
          id: crypto.randomUUID(),
          ...pick
        });
      }
      saveDevices();
      render();
      toast("Discovery complete", `Added ${addCount} devices to inventory.`);
    }

    function randIP(){
      const x = Math.floor(Math.random()*120)+20;
      return `192.168.1.${x}`;
    }

    function openAdd(){
      editingId = null;
      el("addTitle").textContent = "Add IoT Device";
      el("addSubtitle").textContent = "Manually add a device. Risk scoring will apply on scan.";
      clearForm();
      openModal("modalAdd");
    }

    function editDevice(id){
      const d = devices.find(x=>x.id===id);
      if(!d) return;
      editingId = id;

      el("addTitle").textContent = "Edit Device";
      el("addSubtitle").textContent = "Update device info. Scores refresh automatically.";

      el("fName").value = d.name || "";
      el("fType").value = d.type || "Other";
      el("fIP").value = d.ip || "";
      el("fProto").value = (d.protocols||[]).join(", ");
      el("fPorts").value = (d.ports||[]).join(", ");
      el("fFirmware").value = d.firmware || "Unknown";
      el("fWeak").value = String(d.weakAuth);
      el("fNotes").value = d.notes || "";

      openModal("modalAdd");
    }

    function addOrUpdateDeviceFromForm(){
      const name = el("fName").value.trim() || "Unnamed Device";
      const type = el("fType").value;
      const ip = el("fIP").value.trim() || randIP();
      const proto = el("fProto").value.split(",").map(s=>s.trim()).filter(Boolean);
      const ports = el("fPorts").value.split(",").map(s=>Number(s.trim())).filter(n=>Number.isFinite(n));
      const notes = el("fNotes").value.trim();
      const firmware = el("fFirmware").value;

      let weakAuth = false;
      const weakChoice = el("fWeak").value;
      if(weakChoice === "auto"){
        weakAuth = /camera|sensor|other/i.test(type) ? Math.random() < 0.35 : Math.random() < 0.18;
      }else{
        weakAuth = weakChoice === "true";
      }

      if(editingId){
        devices = devices.map(d=>{
          if(d.id !== editingId) return d;
          return {
            ...d,
            name, type, ip,
            protocols: proto.length ? proto : ["HTTPS"],
            ports: ports.length ? ports : [443],
            firmware,
            weakAuth,
            notes
          };
        });
        toast("Device updated", `${name} updated successfully.`);
      }else{
        devices.push({
          id: crypto.randomUUID(),
          name, type, ip,
          protocols: proto.length ? proto : ["HTTPS"],
          ports: ports.length ? ports : [443],
          weakAuth,
          firmware,
          lastScan: null,
          notes,
          history: []
        });
        toast("Device added", `${name} is now in your inventory.`);
      }

      saveDevices();
      closeModal("modalAdd");
      clearForm();
      editingId = null;
      render();
    }

    function clearForm(){
      ["fName","fIP","fPorts","fNotes"].forEach(id=>el(id).value="");
      el("fType").value="Camera";
      el("fProto").value="HTTP, MQTT";
      el("fFirmware").value="Up-to-date";
      el("fWeak").value="auto";
    }

    function removeDevice(id){
      const d = devices.find(x=>x.id===id);
      if(!confirm(`Delete "${d?.name || "device"}"?`)) return;
      devices = devices.filter(x=>x.id!==id);
      saveDevices();
      render();
      toast("Device removed", d ? `${d.name} deleted.` : "Device removed.");
      if(detailsId === id){
        closeModal("modalDetails");
        detailsId = null;
      }
    }

    async function scanOne(id){
      openModal("modalScan");
      await runScan([id]);
    }

    async function scanAll(){
      openModal("modalScan");
      await runScan(devices.map(d=>d.id));
    }

    async function runScan(ids){
      const bar = el("scanBar");
      const log = el("scanLog");
      const scanText = el("scanText");

      bar.style.width = "0%";
      log.innerHTML = "";
      scanText.textContent = "Initializing scan engine…";

      const steps = [
        "Mapping network topology…",
        "Detecting active IoT endpoints…",
        "Enumerating open ports…",
        "Checking insecure protocols…",
        "Validating firmware state…",
        "Evaluating authentication hygiene…",
        "Computing security risk score…",
        "Generating recommendations…"
      ];

      for(let i=0;i<steps.length;i++){
        scanText.textContent = steps[i];
        log.innerHTML += `✔ ${steps[i]}<br/>`;
        const progress = Math.round(((i+1)/steps.length)*100);
        bar.style.width = progress + "%";
        await sleep(380 + Math.random()*380);
      }

      // Mutate some values to simulate scan findings
      devices = devices.map(d=>{
        if(!ids.includes(d.id)) return d;

        const fwStates = ["Up-to-date","Up-to-date","Unknown","Outdated"];
        const newFw = fwStates[Math.floor(Math.random()*fwStates.length)];

        const weak = Math.random() < 0.22 ? true : d.weakAuth;

        let ports = d.ports || [443];
        if(Math.random() < 0.25){
          const add = [80,1883,554,22,23,1900][Math.floor(Math.random()*6)];
          ports = Array.from(new Set([...ports, add]));
        }
        if(Math.random() < 0.18 && ports.length > 1){
          ports = ports.filter((_,idx)=>idx!==0);
        }

        const updated = {
          ...d,
          firmware: newFw,
          weakAuth: weak,
          ports,
          lastScan: new Date().toISOString()
        };

        // Push scan history entry
        const scored = scoreDevice(updated);
        const entry = {
          t: updated.lastScan,
          score: scored.score,
          status: scored.status,
          issues: scored.vulns.length
        };

        updated.history = Array.isArray(updated.history) ? [...updated.history, entry].slice(-25) : [entry];

        return updated;
      });

      saveDevices();
      render();

      toast("Scan completed", `Scanned ${ids.length} device(s). Scores updated.`);
      scanText.textContent = "Scan complete.";
      log.innerHTML += `<br/><b>✔ Scan complete.</b>`;
    }

    function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

    function exportJSON(){
      const payload = computeAll();
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "iot-cyber-hygiene-report.json";
      a.click();
      URL.revokeObjectURL(a.href);
      toast("Exported", "Downloaded JSON report.");
    }

    function exportCSV(){
      const rows = computeAll().map(d=>({
        name: d.name,
        type: d.type,
        ip: d.ip,
        protocols: (d.protocols||[]).join("|"),
        ports: (d.ports||[]).join("|"),
        firmware: d.firmware,
        weakAuth: d.weakAuth ? "YES" : "NO",
        score: d.score,
        status: d.status,
        lastScan: d.lastScan ? new Date(d.lastScan).toLocaleString() : ""
      }));

      const headers = Object.keys(rows[0] || {name:""});
      const csv = [
        headers.join(","),
        ...rows.map(r=>headers.map(h=>csvEscape(r[h])).join(","))
      ].join("\n");

      const blob = new Blob([csv], {type:"text/csv"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "iot-cyber-hygiene-report.csv";
      a.click();
      URL.revokeObjectURL(a.href);
      toast("Exported", "Downloaded CSV report.");
    }

    function exportHTMLReport(){
      const list = computeAll();
      const html = `
<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>IoT Cyber-Hygiene Report</title>
<style>
body{font-family: Arial, sans-serif; padding: 24px; color:#111;}
h1{margin:0 0 8px 0;}
p{margin: 4px 0 18px 0; color:#444;}
table{width:100%; border-collapse:collapse; margin-top:14px;}
th,td{border:1px solid #ddd; padding:10px; font-size:13px;}
th{background:#f5f5f5; text-align:left;}
.badge{padding:4px 10px; border-radius:999px; border:1px solid #ddd; font-weight:700;}
</style>
</head>
<body>
<h1>IoT Cyber-Hygiene Assistant — Report</h1>
<p>Generated: ${new Date().toLocaleString()}</p>
<table>
<thead>
<tr>
<th>Device</th><th>IP</th><th>Type</th><th>Protocols</th><th>Ports</th><th>Score</th><th>Status</th>
</tr>
</thead>
<tbody>
${list.map(d=>`
<tr>
<td>${escapeHtml(d.name)}</td>
<td>${escapeHtml(d.ip)}</td>
<td>${escapeHtml(d.type)}</td>
<td>${escapeHtml((d.protocols||[]).join(", "))}</td>
<td>${escapeHtml((d.ports||[]).join(", "))}</td>
<td><b>${d.score}</b></td>
<td>${escapeHtml(d.status)}</td>
</tr>
`).join("")}
</tbody>
</table>
<p style="margin-top:18px;color:#555;"><b>Note:</b> This report is generated from a research-based frontend prototype.</p>
</body>
</html>`.trim();

      const blob = new Blob([html], {type:"text/html"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "iot-cyber-hygiene-report.html";
      a.click();
      URL.revokeObjectURL(a.href);
      toast("Exported", "Downloaded HTML report.");
    }

    function csvEscape(v){
      const s = String(v ?? "");
      if(/[,"\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
      return s;
    }

    function printReport(){
      toast("Printing", "Opening print dialog…");
      setTimeout(()=>window.print(), 350);
    }

    function resetDemo(){
      if(!confirm("Reset all devices to default demo set?")) return;
      devices = structuredClone(defaultDevices);
      saveDevices();
      render();
      toast("Reset complete", "Demo data restored.");
    }

    /**********************
     * NAV + FILTERS + SEARCH
     **********************/
    function setView(view){
      document.querySelectorAll(".view").forEach(v=>v.style.display="none");
      el("view-"+view).style.display="block";

      document.querySelectorAll("#nav button").forEach(b=>b.classList.remove("active"));
      document.querySelector(`#nav button[data-view="${view}"]`).classList.add("active");
    }

    function setFilter(f){
      activeFilter = f;
      el("filterLabel").textContent =
        f==="all" ? "All" : f==="safe" ? "Safe" : f==="moderate" ? "Moderate" : "High Risk";
      render();
    }

    // Keyboard: Ctrl/⌘ + K
    window.addEventListener("keydown",(e)=>{
      const isMac = navigator.platform.toLowerCase().includes("mac");
      if((isMac ? e.metaKey : e.ctrlKey) && e.key.toLowerCase()==="k"){
        e.preventDefault();
        el("searchInput").focus();
      }
    });

    /**********************
     * HELPERS
     **********************/
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /**********************
     * HOOK EVENTS
     **********************/
    document.querySelectorAll("#nav button").forEach(btn=>{
      btn.addEventListener("click", ()=>setView(btn.dataset.view));
    });

    document.querySelectorAll("[data-filter]").forEach(btn=>{
      btn.addEventListener("click", ()=>setFilter(btn.dataset.filter));
    });

    el("btnDiscover").addEventListener("click", discover);
    el("btnAdd").addEventListener("click", openAdd);
    el("btnSaveDevice").addEventListener("click", addOrUpdateDeviceFromForm);
    el("btnScanAll").addEventListener("click", scanAll);

    el("btnExportJSON").addEventListener("click", exportJSON);
    el("btnExportCSV").addEventListener("click", exportCSV);
    el("btnExportHTML").addEventListener("click", exportHTMLReport);
    el("btnPrint").addEventListener("click", printReport);
    el("btnReset").addEventListener("click", resetDemo);

    el("searchInput").addEventListener("input", (e)=>{
      searchQuery = e.target.value;
      render();
    });

    // Close modal on backdrop click
    ["modalAdd","modalScan","modalDetails"].forEach(mid=>{
      el(mid).addEventListener("click",(e)=>{
        if(e.target === el(mid)) closeModal(mid);
      });
    });

    // Initial render
    render();

    // Resize charts
    window.addEventListener("resize", ()=>{
      render();
    });
  </script>
</body>
</html>
